#!/usr/bin/env bash
# vim: set ft=sh:

set -euo pipefail

_ROOT="$(dirname "${BASH_SOURCE[0]}")/.."

# Optional flags:
# - INSTALL_PACKAGES=1 : run distro package installation
# - PACKAGE_PROFILE=core|dev : package profile to apply when INSTALL_PACKAGES=1
# - NVM_NODE_VERSION=<version> : node version for nvm (default: lts/*)
# - INSTALL_NVIM=1     : run Neovim plugin/bootstrap setup
# - FULL_SETUP=1       : run extra toolchain installers from hooks/os
INSTALL_PACKAGES="${INSTALL_PACKAGES:-0}"
PACKAGE_PROFILE="${PACKAGE_PROFILE:-core}"
INSTALL_NVIM="${INSTALL_NVIM:-0}"
FULL_SETUP="${FULL_SETUP:-0}"
SET_ZSH_DEFAULT="${SET_ZSH_DEFAULT:-1}"

touch "$HOME/.psqlrc.local"

. "${_ROOT}/hooks/os"

os::get_distro
os::ensure_zsh
if [[ "${SET_ZSH_DEFAULT}" == "1" ]]; then
  os::ensure_user_shell_zsh
else
  log::f "Skipping login shell update (set SET_ZSH_DEFAULT=1 to enable)"
fi

if [[ "${INSTALL_PACKAGES}" == "1" ]]; then
  if [[ "${DISTRO}" =~ ^(Ubuntu|debian) ]]; then
    log::f "Ubuntu/debian detected, installing packages profile=${PACKAGE_PROFILE}"
    case "${PACKAGE_PROFILE}" in
      core)
        os::ubuntu::install_packages_core
        ;;
      dev)
        os::ubuntu::install_packages_core
        os::ubuntu::install_packages_dev
        ;;
      *)
        log::e "Unknown PACKAGE_PROFILE=${PACKAGE_PROFILE}. Supported: core, dev"
        exit 1
        ;;
    esac
  else
    log::e "Unsupported distribution ${DISTRO}"
    exit 1
  fi
else
  log::f "Skipping package installation (set INSTALL_PACKAGES=1 to enable)"
fi

# install zplug if not installed
if [ ! -d "$HOME/.zplug" ]; then
  git clone https://github.com/zplug/zplug "$HOME/.zplug"
fi
if [ -s "$HOME/.zplug/init.zsh" ]; then
  if command -v zsh >/dev/null 2>&1; then
    # Install zplug plugins non-interactively so shell setup is fully bootstrapped.
    zsh -lc 'source "$HOME/.zplug/init.zsh"; zplug check || zplug install' || true
  else
    log::f "Skipping zplug bootstrap: zsh not installed (install zsh or run with INSTALL_PACKAGES=1)"
  fi
fi

if [ ! -d "$HOME/.tmux/plugins/tpm" ]; then
  git clone https://github.com/tmux-plugins/tpm "$HOME/.tmux/plugins/tpm"
  "$HOME/.tmux/plugins/tpm/bin/install_plugins"
fi

if [ -f "$HOME/.config/zoomus.conf" ]; then
  os::set_zoom_scaling_factor
fi

if [[ "${INSTALL_NVIM}" == "1" ]]; then
  . "${_ROOT}/hooks/nvim"
else
  log::f "Skipping Neovim bootstrap (set INSTALL_NVIM=1 to enable)"
fi

if [[ "${FULL_SETUP}" == "1" ]]; then
  tools::full_install
else
  log::f "Skipping full tool installation (set FULL_SETUP=1 to enable)"
fi
